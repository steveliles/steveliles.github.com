
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <link rel="stylesheet" href="css/styles.css" type="text/css" media="screen"/>
    <link rel="alternate" type="application/rss+xml" title="ExoMemory" href="http://steveliles.github.com/rss.xml" />
    <link href='http://fonts.googleapis.com/css?family=Gochi+Hand' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono:700' rel='stylesheet' type='text/css'>
    <meta name="description" content="Thoughts on Java, GWT, programming, and other geek stuff"></meta>
    <script type="text/javascript" src="google-analytics.js"></script>
    <title>Steve Liles' Blog</title>
  </head>
  <body>
    <div>
      <div class="site-header">
        <div class="left">
          <a href="/index.html"><h1>ExoMemory</h1></a>
          <h2>Because I'll forget it if I don't write it down...</h2>
        </div>
        <div class="right">
	  <a rel="author" href="http://steveliles.github.com/about_me.html"><img src="images/lego.png"></a>
        </div>
      </div>
      <div class="nav">
        <span>
          <a rel="me" href="https://plus.google.com/105248011271585565954"><img src="https://ssl.gstatic.com/images/icons/gplus-16.png" width="16" height="16"></a>
          <a rel="me" href="http://www.twitter.com/steveliles"><img src="http://twitter-badges.s3.amazonaws.com/t_mini-a.png" alt="Follow steveliles on Twitter"></a>
	  <a rel="me" href="http://uk.linkedin.com/in/steveliles"><img src="http://www.linkedin.com/img/webpromo/btn_in_20x15.png" width="20" height="15" alt="View my LinkedIn profile"></a>
	  <form action="http://www.google.com/search" method="get">
            <input type="hidden" name="q" value="site:steveliles.github.com">
            <input type="text" name="q" placeholder="search"></input>
          </form>
	  <a href="rss.xml"><img src="images/rss.png" width="16" height="16" alt="Subscribe to RSS feed"></a>
        </span>
      </div>
      <div class="content">
        <div class="main">
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1,140" description="For my first ever attempt at writing Clojure code I had a shot at a Roman numeral converter">
              <span class="meta" itemprop="datePublished"><time datetime="2013-02-28">February 28, 2013</time></span>
              <a itemprop="url" href="roman_numeral_conversion_in_clojure.html"><h1 itemprop="name" itemprop="headline">Roman numeral conversion in Clojure</h1></a>
	      <span itemprop="articleBody"><p><a style="float:left; margin-right:10px" href="http://www.amazon.co.uk/gp/product/1934356867/ref=as_li_ss_il?ie=UTF8&amp;camp=1634&amp;creative=19450&amp;creativeASIN=1934356867&amp;linkCode=as2&amp;tag=stlibl-21"><img border="0" src="http://ws.assoc-amazon.co.uk/widgets/q?_encoding=UTF8&amp;ASIN=1934356867&amp;Format=_SL110_&amp;ID=AsinImage&amp;MarketPlace=GB&amp;ServiceVersion=20070822&amp;WS=1&amp;tag=stlibl-21" ></a></p>

<p>I've been reading Stu Halloway's <a href="http://www.amazon.co.uk/gp/product/1934356867/ref=as_li_ss_tl?ie=UTF8&amp;camp=1634&amp;creative=19450&amp;creativeASIN=1934356867&amp;linkCode=as2&amp;tag=stlibl-21">Programming Clojure</a> (which is excellent by the way). When I reached chapter 6 "Concurrency" I thought I'd better pause and practise some of the basics before venturing into deeper waters!</p>

<p>I once saw a programming challenge posted with a job ad, which asked applicants to write some code to convert numbers from the decimal numeral system to Roman. This seemed like a sufficiently challenging and self-contained thing to try for a first attempt at Clojure.</p>

<p>I started by creating a map of the individual numerals:</p>

<pre><code>(def digits {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})
</code></pre>

<p>Maps are functions, so invoking a map with a key gives the value, like this:</p>

<pre><code>=&gt; (digits \X)
10
</code></pre>

<p>Next I created a function that maps roman numerals to decimal values (baby steps!):</p>

<pre><code>(defn decimal-values [s]
  (map digits s))
</code></pre>

<p>Testing this at the REPL I get:</p>

<pre><code>=&gt; (decimal-values "MCXVII")
(1000 100 10 5 1 1)
</code></pre>

<p>Great, I have a list of the values which I need to compose together. Next I want to combine the values in this list by adding them together.</p>

<pre><code>(defn roman [s]
  (reduce + (decimal-values s)))
</code></pre>

<p>Testing again at the REPL I get:</p>

<pre><code>=&gt; (roman "MCXVII")
1117
</code></pre>

<p>Whoop! OK, we have our first conversion. Are we done? Unfortunately not - there's a complication.</p>

<p>The "simple" way of writing 4 in Roman numerals is IIII. That repetition is allowed, but not commonly used. The short-hand is to prefix a higher numeral with a lower one, e.g. IV, which means subtract the lower number from the higher. This works for all of the other numerals too, so 999 can be written IM (1000 - 1).</p>

<p>I pondered this for a while, then decided to write a <code>combine-numerals</code> function to use in place of + in the <code>reduce</code> call. I want my <code>roman</code> function to look like this:</p>

<pre><code>(defn roman [s]
  (reduce combine-numerals (decimal-values s)))
</code></pre>

<p>Now, <code>combine-numerals</code> needs to account for the more complicated logic described above. Here's what I came up with:</p>

<pre><code>(defn combine-numerals [a b]
  (if (&gt; a b)
    (+ a b)
    (- b a)))
</code></pre>

<p>This simply checks that the value seen first is larger than the following value - if it is we add, if it isn't we subtract. Testing that at the REPL gives:</p>

<pre><code>=&gt; (combine-numerals 1 10)
9
=&gt; (combine-numerals 10 1)
11
</code></pre>

<p>Perfect, if I see a 1 before a 10 it is subtracted to give 9, otherwise it is added to give 11. Lets try our <code>roman</code> function again:</p>

<pre><code>=&gt; (roman "XVII")
17
=&gt; (roman "MCMXVII")
2117
</code></pre>

<p>Hmm, that last one isn't right, it should give 1917. What's going on? </p>

<p><code>reduce</code> takes each value in the given list and applies the function to it and the reduced result so far. That means that when <code>combine-numerals</code> is called it isn't called with two adjacent values except in the case where the numeral string only has two numerals. Bum.</p>

<p>What I really need is to have the sum so far, the previous numeral seen, and the current numeral being handled, so that I can decide whether to add/subtract the current numeral by comparing it with the previous numeral. </p>

<p>I think I could do this with a recursive function, but I'm struggling to remember the syntax, so I ponder a little more and decide to try running in reverse through the numerals, and add if the total so far is less than 4 times the current total. </p>

<p>This involves changing <code>combine-numerals</code> to multiply the current numeral's value by 4 before comparing, and renaming it to add-numeral:</p>

<pre><code>(def add-numeral [n t]
  (if (&gt; n (* 4 t))
    (- n t)
    (+ t n)))
</code></pre>

<p>I also need to change <code>roman</code> to reduce the list in reverse with the new add-numeral function:</p>

<pre><code>(defn roman [s]
  (reduce add-numeral (map digits (reverse s))))
</code></pre>

<p>Testing at the REPL gives:</p>

<pre><code>=&gt; (roman "IX")
9
=&gt; (roman "MCMXIX")
1919
=&gt; (roman "MIM")
1999
=&gt; (roman "MLMXXXIIII")
1984
=&gt; (roman "MCMLXXXIV")
1984
</code></pre>

<p>So, lets see the whole program:</p>

<pre><code>(def digits {\I 1, \V 5, \X 10, \L 50, \C 100, \D 500, \M 1000})

(def add-numeral [n t]
  (if (&gt; n (* 4 t))
    (- n t)
    (+ t n)))

(defn roman [s]
  (reduce add-numeral (map digits (reverse s))))
</code></pre>

<p>I confess myself truly amazed that -</p>

<ol>
<li>I managed to write some Clojure that actually works</li>
<li>I think it is nearly idiomatic Clojure (is it? please comment!)</li>
<li>It is incredibly concise and moderately readable (even to my unfamiliar eyes)</li>
</ol>

<p>I plan to come back to this exercise over time as I learn more Clojure - pretty sure there's a recursive version that would be more idiomatic/elegant, and I haven't made any attempt at handling bad input, etc.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=clojure">clojure</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=exercise">exercise</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=roman-numerals">roman-numerals</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="roman_numeral_conversion_in_clojure.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="156" description="Loading the correct GWT language permutation according to the browser (user-agent) locale.">
              <span class="meta" itemprop="datePublished"><time datetime="2013-02-27">February 27, 2013</time></span>
              <a itemprop="url" href="gwt_i18n_using_browser_locale.html"><h1 itemprop="name" itemprop="headline">GWT i18n using browser locale</h1></a>
	      <span itemprop="articleBody"><p>I was trying to get GWT to load a localised permutation based on the user's browser locale. For whatever reason I didn't have much luck coming up with a good combination of search keywords to get a good hit from Google.</p>

<p>After rummaging around in the bowels of GWT I found that it is possible to use the browser locale to determine the build permutation to use. </p>

<p>It doesn't seem all that well publicised or documented (does not figure in the <a href="https://developers.google.com/web-toolkit/doc/latest/DevGuideI18n">i18n docs</a> for example), although it is used in the <a href="http://google-web-toolkit.googlecode.com/svn-history/r11299/trunk/samples/showcase/src/com/google/gwt/sample/showcase/Showcase.gwt.xml">showcase demo app</a>.</p>

<p>There are clues as to why it isn't well publicised in the <a href="http://code.google.com/p/google-web-toolkit/issues/detail?id=4228">bug containing the original patch</a>.</p>

<p>To use the browser's locale to determine the permutation, simply add the following to the module.gwt.xml:</p>

<pre><code>&lt;set-configuration-property name="locale.useragent" value="Y"/&gt;
</code></pre>

<p>Setting the locale of chrome for testing is explained for <a href="http://developer.chrome.com/extensions/i18n.html#testing-win">windows</a>, <a href="http://developer.chrome.com/extensions/i18n.html#testing-linux">linux</a>, and <a href="http://developer.chrome.com/extensions/i18n.html#testing-mac">mac</a>.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=GWT">GWT</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=i18n">i18n</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=l10n">l10n</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=locale">locale</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="gwt_i18n_using_browser_locale.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="1,314" description="Communication between frames/windows in javascript is fine until some of your frames are served from different domains. Communication between frames in different domains is still possible, but you have to work in a very different way...">
              <span class="meta" itemprop="datePublished"><time datetime="2013-02-05">February 05, 2013</time></span>
              <a itemprop="url" href="cross_domain_inter_frame_communication_in_javascript.html"><h1 itemprop="name" itemprop="headline">Cross-domain inter-frame communication in javascript</h1></a>
	      <span itemprop="articleBody"><p><em>Requirement:</em> </p>

<p>Web-page A from domain A' loads web-page B from domain B' into an iframe. Web-page B wants to be able to render some content into the DOM of web-page A (outside of the view-port described by B's iframe). The content which B renders into A needs to be able to HTTP GET and POST data back to the domain B', handle the responses, and update the rendered content in web-page A.</p>

<p><em>Problems:</em></p>

<ul>
<li>Scripts loaded into pages from different domains cannot interact so, for example, page B's scripts cannot <em>simply</em>* render content into the parent frame (page A)</li>
<li>Page A cannot <em>simply</em>* use XMLHTTPRequest to GET/POST/PUT/DELETE to host B</li>
</ul>

<p>[*] I say "simply" because you can't just expect it to work like it would in a same-domain environment, but it is possible!</p>

<h3>Escaping from an iframe</h3>

<p>Lets start with rendering content into a parent frame. To get concrete, lets say that domain A is www.domain.com, while domain B is sub.domain.com. </p>

<p>Yes, they are sub-domains of a common root. No, B is <em>not</em> allowed to modify the DOM of A, or communicate with scripts in A, because web-browsers won't allow that unless the ports, protocols, <em>and</em> domains match <em>exactly</em>.</p>

<p>The only way for B to escape from the iframe is to have co-operation from A. That co-operation can come in one of two forms: </p>

<ol>
<li>Both pages must explicitly set the <code>document.domain</code> property to the same value (e.g. domain.com). Even if one of the pages is served directly from "domain.com", the act of explicitly setting the domain is required for this technique to work - it signals to the browser that the two pages want to collaborate.</li>
<li>Have host A serve an iframe-buster page (more below)</li>
</ol>

<h4>Iframe Buster</h4>

<p>Host A can serve a page which loads scripts on behalf of B, sometimes known as an <a href="http://www.adopstools.net/?section=miscellaneous&amp;page=iframes">iframe-buster</a>. </p>

<p>This is a common technique in the ad-delivery world to allow complex ads like page take-over's to escape from the iframe they are loaded into. Note that this is not an exploit as such, since it requires host A to be complicit.</p>

<p>To illustrate how it works, here's what a very simple iframe-buster might look like:</p>

<pre><code>&amp;#60;!DOCTYPE HTML PUBLIC 
  "-//W3C//DTD HTML 4.01 Transitional//EN" 
  "http://www.w3.org/TR/html4/strict.dtd"&gt;
&amp;#60;html&gt;
  &amp;#60;body&gt;
    &amp;#60;script type="text/javascript" language="javascript"&gt;
      var _url = "http://www.domain.com/bust.js?" + document.location.search;
      var _script = document.createElement("script");
      _script.setAttribute("type", "text/javascript");
      _script.setAttribute("src", _url);
      document.body.appendChild(_script);        
    &amp;#60;/script&gt;    
  &amp;#60;/body&gt;
&amp;#60;/html&gt;
</code></pre>

<p>The host-page A will initially load a page from host B. That page B will load the iframe-buster on host A with some parameters which can be used to direct what the bust-out actually does.</p>

<h4>Rendering into the parent DOM</h4>

<p>Now that we have assistance from the host-page domain, our iframe can communicate directly with the DOM and scripts in the parent frame, using the <code>window.parent</code> handle.</p>

<pre><code>var _ctx = window.parent.document;
var _div = _ctx.createElement("div");
_div.innerHTML = '&amp;#60;h1&gt;Hooray!&amp;#60;/h1&gt;';
_ctx.body.appendChild(_div);
</code></pre>

<p>Great!</p>

<h3>Making HTTP requests</h3>

<p>Now we want to fetch some JSON data from host B by HTTP GET, and render it in the parent frame. For GET requests we might be OK - we just need the host API to support JSONP. If it doesn't we need one of the other techniques as for making POST requests â€¦</p>

<p>What if we want to POST some data to host B? We can't use XMLHTTPRequest to POST from A to B, as the browser security policies won't allow it. So, what are our options?</p>

<ol>
<li>HTML Form POST</li>
<li>CORS (Cross Origin Resource Sharing)</li>
<li>Pipelined communication through another frame</li>
</ol>

<h4>HTML Form POST</h4>

<p>We could use a form POST, which <em>is</em> allowed to POST to another domain (mostly because the HTML Form POST spec pre-dates the tightened security policies), and will receive the response. </p>

<p>You'll need to do a bit of scripting to wrap things up so that you can register callbacks and have things behave <em>similarly</em> to an XMLHTTPRequest.</p>

<p>This method has the advantage of broad browser compatibility, but the implementation is by necessity less clean, and you lose some of the advantages of XMLHTTPRequest (e.g. the ability to check the response status code). </p>

<p>If you're dealing with a pure RESTful API you'll struggle without the ability to check status codes. </p>

<p>If you have help from the server-side you can probably engineer your way around most of the problems, and even tunnel non-POST API calls by using hidden FORM params and a server-side intercept (e.g. Servlet Filter) to translate the request for you before it hits the API handlers. </p>

<p>That said, if you have control of (or co-operation from) the server-side you'll probably want to look at one of the other methods below.</p>

<p>Advantages:</p>

<ol>
<li>Good browser compatibility</li>
<li>Easily understood</li>
</ol>

<p>Disadvantages:</p>

<ol>
<li>Poor handling of pure RESTful APIs</li>
</ol>

<h4>CORS (Cross Origin Resource Sharing)</h4>

<p>We could use <a href="http://en.wikipedia.org/wiki/Cross-origin_resource_sharing">CORS</a>, which involves the web-server B checking and sending additional HTTP headers. </p>

<p>This requires a relatively modern browser and some server-side work to check and set additional HTTP headers. CORS is nice because it allows us to conveniently use XMLHTTPRequest for all of our requests (and no need for JSONP).</p>

<p>CORS might put a little extra demand on your servers, as browsers "pre-flight" requests as part of the CORS protocol.</p>

<p>Advantages:</p>

<ol>
<li>Just like working in a same-domain environment (good for RESTful API handling)</li>
<li>CORS is an emerging standard, so you don't necessarily need to own/operate the host for this method to be a realistic possibility</li>
</ol>

<p>Disadvantages:</p>

<ol>
<li>Requires modern browser</li>
<li>Requires that the host supports CORS</li>
<li>Some HTTP request overhead (pre-flight)</li>
</ol>

<h4>Pipeline communication through another iframe</h4>

<p>A third option is to pipeline your HTTP calls through another iframe - loaded from the domain of the host you want to make calls to.</p>

<p>In newer browsers we can use <code>window.postMessage</code> to send text between frames loaded from different domains. </p>

<p>Since this text can be JSON, and you can register event-handlers for the "message" event, you can set up a communication-frame per host that you need to talk to, and from inside that frame you can use straight-forward XMLHTTPRequest calls, same-domain style.</p>

<p>There are some neat libraries that use a variety of fallback methods (message-passing via window.name; flash) to make this work in older browsers. The most popular one seems to be <a href="http://easyxdm.net/wp/">EasyXDM</a>.</p>

<p>Advantages:
1. Good browser compatibility (use libraries like EasyXDM)
2. Good for RESTful API handling</p>

<p>Disadvantages:</p>

<ol>
<li>More complex set-up</li>
<li>You need control of the host</li>
<li>There's some small overhead in piping everything as strings through nested iframe's</li>
</ol>

<h3>Summary</h3>

<p>As with everything, there is no one-size-fits-all solution, and some flexibility and compromise is likely to be necessary. For the project I'm working on currently I'm using iframe busters, a little CORS, and a lot of pipelining through another frame, but YMMV.</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=javascript">javascript</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=iframe">iframe</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=window">window</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=cross-domain">cross-domain</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=postMessage">postMessage</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="cross_domain_inter_frame_communication_in_javascript.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="237" description="Getting javahl subversion integration working with Eclipse, Subclipse and Ubuntu 12.10">
              <span class="meta" itemprop="datePublished"><time datetime="2012-11-13">November 13, 2012</time></span>
              <a itemprop="url" href="subversion_1_7_eclipse_integration_in_ubuntu_12.html"><h1 itemprop="name" itemprop="headline">Subversion 1.7 Eclipse integration in Ubuntu 12</h1></a>
	      <span itemprop="articleBody"><p>Almost a year ago I <a href="http://steveliles.github.com/subversion_1_7_eclipse_integration_in_ubuntu.html">posted</a> about getting Subclipse/Subversion/Eclipse/Javahl to play nicely together in Ubuntu 11.10. </p>

<p>Things have changed a little with Quantal Quetzal (notably that canonical have updated their repo's to support SVN 1.7.7 and that the libsvn-java installation has moved), so here's an updated note for getting Subversion 1.7.x integration working with Eclipse (3.7.x) and Subclipse 1.8.x on Ubuntu 12.10.</p>

<p>I'm assuming you already have Eclipse and Subclipse installed (with all the optional extras). </p>

<p>To use the native svn integration you will of course need subversion installed, so install Subversion from canonical's repo's - <code>sudo apt-get install subversion</code>.</p>

<p>You'll also need libsvn-java, to allow subclipse to talk to svn - <code>sudo apt-get install libsvn-java</code>.</p>

<p>To enable Eclipse to see your libsvn-java installation, go to the eclipse install directory (I install in <code>/home/steve/dev/tools/eclipse</code>) and edit the eclipse.ini file. </p>

<p>You need to add <code>-Djava.library.path=/usr/lib/x86_64-linux-gnu/jni/</code>, which is where libsvn-java's native libraries get installed. Add it immediately following <code>-vmargs</code>. My eclipse.ini file now looks like this:</p>

<pre><code>-startup
plugins/org.eclipse.equinox.launcher_1.2.0.v20110502.jar
--launcher.library
plugins/org.eclipse.equinox.launcher.gtk.linux.x86_64_1.1.100.v20110505
-showsplash
org.eclipse.platform
--launcher.XXMaxPermSize
256m
--launcher.defaultAction
openFile
-vmargs
-Djava.library.path=/usr/lib/x86_64-linux-gnu/jni/
-Xms40m
-Xmx600m
</code></pre>

<p>If you use Subclipse but never previously installed Javahl you probably see irritating warning dialogs the first time you do <em>anything</em> in Eclipse after a restart. Installing javahl correctly will prevent those :).</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=ubuntu">ubuntu</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=eclipse">eclipse</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=subversion">subversion</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=javahl">javahl</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=subclipse">subclipse</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=quantal">quantal</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="subversion_1_7_eclipse_integration_in_ubuntu_12.html">Comment on this post</a>

            </div>
	    <div class="article" itemscope itemtype="http://schema.org/BlogPosting" inLanguage="en-GB" isFamilyFriendly="true" wordCount="996" description="Setting up embedded Jetty with Spring-MVC and xml configuration is straight-forward. Setting up the same configuration with zero xml proved to be much more tricky!">
              <span class="meta" itemprop="datePublished"><time datetime="2012-11-13">November 13, 2012</time></span>
              <a itemprop="url" href="setting_up_embedded_jetty_8_and_spring_mvc_with_maven_and_no_xml.html"><h1 itemprop="name" itemprop="headline">Setting up embedded Jetty 8 and Spring MVC with Maven and NO XML</h1></a>
	      <span itemprop="articleBody"><p>You can check out the complete source of this simple project from <a href="https://github.com/steveliles/jetty-embedded-spring-mvc-noxml">github</a>. If you want to set up <em>with</em> XML configuration, check my <a href="http://steveliles.github.com/setting_up_embedded_jetty_8_and_spring_mvc_with_maven.html">earlier post</a>.</p>

<p>Starting a new project, and irritated by xml configuration, I thought I'd try Spring @MVC (annotation configured MVC) with Jetty-8 embedded using the no xml servlet 3.0 configuration approach.</p>

<h3>Initializing the Servlet Context</h3>

<p>The Servlet 3 spec introduces the ability to configure the servlet context from code, via implementations of <code>ServletContainerInitializer</code>. You can dynamically configure Servlets and Filters here.</p>

<p>Spring @MVC provides an implementation of <code>ServletContainerInitializer</code> (<code>SpringServletContainerInitializer</code>) which tells the container to scan for classes which implement <code>WebApplicationInitializer</code>, so when using @MVC we need to provide an implementation of <code>WebApplicationInitializer</code>. </p>

<p>Here's a simple one that gets us up and running with a Spring DispatcherServlet mapped to "/" and JSP processing for *.jsp requests (including those forwarded from Controllers):</p>

<pre><code>public class WebAppInitializer implements WebApplicationInitializer
{
    private static final String JSP_SERVLET_NAME = "jsp";
    private static final String DISPATCHER_SERVLET_NAME = "dispatcher";

    @Override
    public void onStartup(ServletContext aServletContext) 
    throws ServletException
    {       
        registerListener(aServletContext);
        registerDispatcherServlet(aServletContext);
        registerJspServlet(aServletContext);
    }

    private void registerListener(ServletContext aContext)
    {
        AnnotationConfigWebApplicationContext _root = 
            createContext(ApplicationModule.class);
        aContext.addListener(new ContextLoaderListener(_root));
    }

    private void registerDispatcherServlet(ServletContext aContext)
    {
        AnnotationConfigWebApplicationContext _ctx = 
            createContext(WebModule.class);
        ServletRegistration.Dynamic _dispatcher = 
            aContext.addServlet(
                DISPATCHER_SERVLET_NAME, new DispatcherServlet(_ctx));
        _dispatcher.setLoadOnStartup(1);
        _dispatcher.addMapping("/");
    }

    private void registerJspServlet(ServletContext aContext) {
        ServletRegistration.Dynamic _dispatcher = 
            aContext.addServlet(JSP_SERVLET_NAME, new JspServlet());
        _dispatcher.setLoadOnStartup(1);
        _dispatcher.addMapping("*.jsp");
    }

    private AnnotationConfigWebApplicationContext createContext(
        final Class&lt;?&gt;... aModules)
    {
        AnnotationConfigWebApplicationContext _ctx = 
            new AnnotationConfigWebApplicationContext();
        _ctx.register(aModules);
        return _ctx;
    }
}
</code></pre>

<p>Notice here that I am registering two "Modules" (a naming convention I've adopted for my Spring @Configuration classes) - <code>ApplicationModule</code> and <code>WebModule</code>. I like to configure the various layers of the application separately. </p>

<p>In <code>ApplicationModule</code> I'll put things like scheduled operations and any dependencies those operations need, while anything that is only needed during web request handling I'll put in <code>WebModule</code>.</p>

<p><code>ApplicationModule</code> for a simple web-app might be unnecessary.</p>

<pre><code>@Configuration
public class ApplicationModule
{
    // Declare "application" scope beans here (ie., 
    // beans that are not _only_ used by the web context)
}
</code></pre>

<p><code>WebModule</code> will be used to configure Spring MVC, and for a simple web-app might look like this:</p>

<pre><code>@EnableWebMvc
@Configuration
@ComponentScan(basePackages={"com.sjl"})
public class WebModule extends WebMvcConfigurerAdapter
{
    @Override
    public void addViewControllers(ViewControllerRegistry aRegistry)
    {
        aRegistry.addViewController("/").setViewName("index");
    }

    @Override
    public void addResourceHandlers(ResourceHandlerRegistry aRegistry)
    {
        ResourceHandlerRegistration _res = 
            aRegistry.addResourceHandler("/WEB-INF/view/**/*");
        _res.addResourceLocations(
            "classpath:/META-INF/webapp/WEB-INF/view/");
    }

    @Bean
    public ViewResolver viewResolver() 
    {
        UrlBasedViewResolver _viewResolver = 
            new UrlBasedViewResolver();
        _viewResolver.setViewClass(JstlView.class);
        _viewResolver.setPrefix("WEB-INF/view/");
        _viewResolver.setSuffix(".jsp");
        return _viewResolver;
    }
}
</code></pre>

<p>I'm extending Spring's WebMvcConfigurerAdapter which provides a host of conveniences. Note that this <code>WebModule</code> sets the annotations @EnableWebMvc and @ComponentScan which are equivalent to the xml configuration you're probably familiar with:</p>

<pre><code>&lt;mvc:annotation-driven/&gt;   
&lt;context:component-scan base-package="com.sjl" /&gt;
</code></pre>

<p>The <code>ResourceHandlerRegistration</code> provides a mapping from requests forwarded to <code>/WEB-INF/view/</code> onto the classpath location of the actual files. Without this, for example, Jetty won't be able to find your jsp files when <code>Controller</code>'s forward requests to <code>View</code>'s (the <code>ViewResolver</code>'s prefix must be matched by the <code>ResourceHandler</code>'s path-pattern).</p>

<p>What remains is to instantiate Jetty and have it find its configuration from the classpath. I won't list that here as its quite long, and the full working example is in <a href="https://github.com/steveliles/jetty-embedded-spring-mvc-noxml">github</a>. </p>

<p>An important thing to point out is that there is a <a href="http://stackoverflow.com/questions/13222071/spring-3-1-webapplicationinitializer-embedded-jetty-8-annotationconfiguration">problem with current versions of Jetty (8.1.7)</a> where Jetty won't find your <code>WebApplicationInitializer</code> classes unless they are either inside a Jar or in the WEB-INF/classes. When running embedded from your IDE neither of these will be true. </p>

<p>This results in log output like "No Spring WebApplicationInitializer types detected on classpath" and is why, in my WebServer class, I set a subclass of <code>AnnotationConfiguration</code> which overrides the default Jetty behaviour to also search for non-jar'd classes on the classpath (<a href="https://github.com/steveliles/jetty-embedded-spring-mvc-noxml/blob/master/src/main/java/com/sjl/WebServer.java">see the code</a>from around line 75).</p>
</span>

              <ul class="keywords">
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Jetty">Jetty</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Embedded">Embedded</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Spring">Spring</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=MVC">MVC</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=Maven">Maven</a></li>
                  <li><a itemprop="keywords" href="http://www.google.com/search?q=site:steveliles.github.com&q=no-xml">no-xml</a></li>
              </ul>
              <div style="clear:both"></div>

	        <a href="setting_up_embedded_jetty_8_and_spring_mvc_with_maven_and_no_xml.html">Comment on this post</a>

            </div>
        </div>
        <div class="sidebar">
          <div>
            <div class="twitter-feed" show="4" account="steveliles">
              <h5>Recent Tweets</h5>            
              <ul class="tweets">
                <li class="tweet-template" style="display:none">        
                  <span class="text"></span>&nbsp;<span class="date" format="yyyy"></span>
                </li>
              </ul>
              <a href="https://twitter.com/steveliles" class="twitter-follow-button" data-show-count="false">Follow @steveliles</a>
	      <script src="//platform.twitter.com/widgets.js" type="text/javascript"></script>
            </div>
          </div>
          <div>
            <a href="article-archive.html"><h5>Recent Posts</h5></a>
            <ul>
                <li><a href="roman_numeral_conversion_in_clojure.html">Roman numeral conversion in Clojure</a><span class="date"> - Feb 28, 2013</span></li>
                <li><a href="gwt_i18n_using_browser_locale.html">GWT i18n using browser locale</a><span class="date"> - Feb 27, 2013</span></li>
                <li><a href="cross_domain_inter_frame_communication_in_javascript.html">Cross-domain inter-frame communication in javascript</a><span class="date"> - Feb 05, 2013</span></li>
                <li><a href="subversion_1_7_eclipse_integration_in_ubuntu_12.html">Subversion 1.7 Eclipse integration in Ubuntu 12</a><span class="date"> - Nov 13, 2012</span></li>
                <li><a href="setting_up_embedded_jetty_8_and_spring_mvc_with_maven_and_no_xml.html">Setting up embedded Jetty 8 and Spring MVC with Maven and NO XML</a><span class="date"> - Nov 13, 2012</span></li>
            </ul>
            <a href="article-archive.html">Older posts...</a>
          </div>
        </div>
      </div>
      <div class="nav">
        <div class="links">
          
          <div class="next"><a title="next" href="index_1.html">Older Posts</a></div>
        </div>
      </div>
    </div>
    <script type="text/javascript" language="javascript" src="blog/blog.nocache.js"></script>
  </body>
</html>

